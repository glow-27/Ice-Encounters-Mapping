---
title: "Modeling Framework"
format: html
editor: source
---
```{r}
library(tidyverse)
library(sf)
library(VGAM)
library(lubridate)
library(lme4)
library(spdep)
library(dbscan)
library(car)
library(corrplot)
library(GWmodel)
library(raster)
library(paletteer)
library(caret)
library(pROC)
#library(glmmTMB)
library(viridis)
library(emmeans)
select <- dplyr::select
```

Read in clustered data
```{r}
cnty_clus_offices <- st_read("data/cnty_clus_offices.gpkg")
#head(cnty_clus_offices)
```


```{r}
cnty_clus_offices <- cnty_clus_offices |>
  drop_na(criminality, gender, age, region, avg_p_blk, avg_p_asn , avg_p_his, avg_p_nc, avg_pop_sqm)

cnty_clus_offices$deported <- factor(cnty_clus_offices$deported, levels = c(0,1))

cnty_clus_offices$region <- factor(cnty_clus_offices$region)

cnty_clus_offices$cluster <- factor(cnty_clus_offices$cluster)

cnty_clus_offices$gender <- factor(cnty_clus_offices$gender)

cnty_clus_offices$criminality <- factor(cnty_clus_offices$criminality)

cnty_clus_offices$criminality <- relevel(cnty_clus_offices$criminality, ref = "3 Other Immigration Violator")

cnty_clus_offices$cluster <- relevel(cnty_clus_offices$cluster, ref = "43")


```





### Check for multicollinearity
```{r}
numeric_vars <- cnty_clus_offices |>
  group_by(office) |>
  select(c(avg_p_blk, avg_p_asn , avg_p_his, avg_p_nc, avg_pop_sqm)) |>
  drop_na() |>
  st_drop_geometry()
```

None of correlations are above 0.8, so I can keep all variables in the model
```{r}
corr_mat <- cor(numeric_vars)
corrplot(corr_mat, type="upper", method="ellipse")
```
```{r}
corr_mat
```

## Basic logistic regression
```{r}
cnty_clus_offices <- cnty_clus_offices |>
  mutate(prog_287g = ifelse(event_type == '287(g) Program Activities', 1, 0)) 

cnty_clus_offices$prog_287g <- factor(cnty_clus_offices$prog_287g)
cnty_clus_offices$prog_287g <- relevel(cnty_clus_offices$prog_287g, ref = "0")

freq_table <- table(cnty_clus_offices$prog_287g)
prop.table(freq_table)
```

```{r}
cnty_clus_offices$criminality <- factor(cnty_clus_offices$criminality)

log_reg <-glm(deported ~ criminality + gender + age + region + avg_p_blk + avg_p_asn  + avg_p_his + avg_p_nc + avg_pop_sqm, 
               family = binomial,
               data = cnty_clus_offices)

saveRDS(log_reg , file="models/log_reg.rds")
```
```{r}
log_reg <- readRDS("models/log_reg.rds")
```

```{r}
summary(log_reg)
```


### Moran's I on basic logistic regression
```{r}
cnty_clus_offices$log_resids <- log_reg$residuals
```

At the alpha = 0.05 level, we reject the null hypothesis that the distribution of the average residuals across offices are spatially uncorrelated. We conclude that there is clustering behavior of the residuals. 
```{r}
offices_grouped <- cnty_clus_offices |>
  group_by(office) |>
  mutate(avg_log_resid = mean(log_resids)) |>
  slice(1) |>
  ungroup()

office_coords <- st_coordinates(offices_grouped)

w1 <- 1/as.matrix(st_distance(offices_grouped ,
                              offices_grouped))
w1[is.infinite(w1)] <- 0

attr(w1, "class") <- NULL

moran.test(offices_grouped$avg_log_resid, mat2listw(w1, style="W"))
```



```{r}
table(cnty_clus_offices$prog_287g)
```


## Interacting criminality with cluster 
Cluster reference group: 167
```{r}

cluster_reg_crim <- glm(deported ~ criminality + cluster + criminality:cluster+ gender + age + region + avg_p_blk + avg_p_asn  + avg_p_his +  avg_p_nc  + avg_pop_sqm, 
               family = binomial,
               data = cnty_clus_offices)

saveRDS(cluster_reg_crim, file="cluster_reg_crim.rds")
```


```{r}
cluster_reg_crim <- readRDS("models/cluster_reg_crim.rds")
```


```{r}
summary(cluster_reg_crim)
```

#### Get coefficients for the interaction term for convicted criminals
```{r}
#### Get coefficients for criminality effects
coefs <- summary(cluster_reg_crim)$coefficients
```


```{r}
# Extract main effect of convicted criminal (same for all clusters)
clstr_fixed_crim <- coefs["criminality1 Convicted Criminal", "Estimate"]

# Extract interaction terms (vary by cluster)
clstr_int_crim <- coefs[grep("^criminality1 Convicted Criminal:cluster", rownames(coefs)), , drop = FALSE]

# Set non-significant interactions to 0 (or NA if you prefer)
clstr_int_crim[clstr_int_crim[, "Pr(>|z|)"] > 0.05, "Estimate"] <- 0

# Create interaction dataframe
interaction_df <- data.frame(
  cluster = sub("criminality1 Convicted Criminal:cluster", "", rownames(clstr_int_crim)),
  clstr_crim_int = clstr_int_crim[, "Estimate"]
)

# Add the fixed effect (same for all clusters)
interaction_df <- interaction_df |>
  mutate(clstr_crim_fixed = clstr_fixed_crim)

# For clusters with no interaction term (reference cluster or not in model)
# Add them with interaction = 0
cluster_office_df <- cnty_clus_offices

all_clusters <- unique(cluster_office_df$cluster)  # Get all cluster IDs from your data
interaction_df <- data.frame(cluster = all_clusters) |>
  left_join(interaction_df, by = "cluster") |>
  mutate(
    clstr_crim_fixed = clstr_fixed_crim,  # Same for all
    clstr_crim_int = replace_na(clstr_crim_int, 0)  # 0 if no interaction
  )

# Calculate cluster-specific effect
interaction_df <- interaction_df |>
  mutate(crim_marg = clstr_crim_fixed + clstr_crim_int)
```



```{r}
cluster_office_df <- cnty_clus_offices |>
  group_by(office) |>
  select(c(office, cluster, geom, aor)) |>
  slice(1) |>
  ungroup()
```


```{r}
cluster_office_df <- cluster_office_df|>
  left_join(interaction_df, by = "cluster")
```


Most regions are signiicantly different from each other
```{r}
region_means <- emmeans(cluster_reg_crim, ~ region)
pairs(region_means, adjust = "tukey") # Or "bonferroni", "holm", etc.
```

### Moran's I on cluster:criminality model
```{r}
cnty_clus_offices$clstr_crim_resids <- cluster_reg_crim$residuals
```

At the alpha = 0.05 level, we fail to reject the null hypothesis that the distribution of the average residuals across offices are spatially uncorrelated. (yay!)
```{r}
offices_grouped <- cnty_clus_offices |>
  group_by(office) |>
  mutate(avg_clstr_crim_resid = mean(clstr_crim_resids)) |>
  slice(1) |>
  ungroup()

office_coords <- st_coordinates(offices_grouped)

w1 <- 1/as.matrix(st_distance(offices_grouped ,
                              offices_grouped))
w1[is.infinite(w1)] <- 0

attr(w1, "class") <- NULL

moran.test(offices_grouped$avg_clstr_crim_resid, mat2listw(w1, style="W"))
```



## Interacting criminality with aor
s### exploration: calculate the proportion noncriminal per aor
```{r}
cnty_clus_offices |>
  group_by(aor)|>
  summarize(prop_noncrim = mean(criminality == "3 Other Immigration Violator")) |>
  arrange(desc(prop_noncrim))
```


```{r}

aor_reg <- glm(deported ~ criminality + aor + criminality:aor + gender + age + region + avg_p_blk + avg_p_asn  + avg_p_his + avg_p_nc+  avg_pop_sqm, 
               family = binomial,
               data = cnty_clus_offices)


saveRDS(aor_reg, file="aor_reg.rds")
```

```{r}
aor_reg <- readRDS("models/aor_reg.rds")
```


```{r}
summary(aor_reg)
```


#### Get coefficients for the interaction term for criminals
```{r}
#### Get coefficients for criminality effects at AOR level
coefs <- summary(aor_reg)$coefficients

# Extract main effect of convicted criminal (same for all AORs)
aor_fixed_crim <- coefs["criminality1 Convicted Criminal", "Estimate"]

# Extract interaction terms (vary by AOR)
aor_int_crim <- coefs[grep("^criminality1 Convicted Criminal:aor", rownames(coefs)), , drop = FALSE]

# Set non-significant interactions to 0 (or NA if you prefer)
aor_int_crim[aor_int_crim[, "Pr(>|z|)"] > 0.05, "Estimate"] <- 0

# Create interaction dataframe
aor_interaction_df <- data.frame(
  aor = sub("criminality1 Convicted Criminal:aor", "", rownames(aor_int_crim)),
  aor_crim_int = aor_int_crim[, "Estimate"]
)

# Get all unique AORs from your data
all_aors <- unique(cluster_office_df$aor)

# Add the fixed effect and handle missing interactions
aor_interaction_df <- data.frame(aor = all_aors) |>
  left_join(aor_interaction_df, by = "aor") |>
  mutate(
    aor_crim_fixed = aor_fixed_crim,  # Same for all AORs
    aor_crim_int = replace_na(aor_crim_int, 0)  # 0 if no interaction (reference AOR)
  )

# Calculate marginal effect
aor_interaction_df <- aor_interaction_df |>
  mutate(aor_crim_marg = aor_crim_fixed + aor_crim_int)


cluster_office_df <- cluster_office_df |>
  left_join(aor_interaction_df, by = "aor")
```

```{r}
aor_interaction_df_pct <- aor_interaction_df |>
  mutate(aor_crim_marg_pctdiff = exp(aor_crim_marg) * 100) 
```




### Moran's I on aor:criminality model
```{r}
cnty_clus_offices$aor_crim_resids <- aor_reg$residuals
```

At the alpha = 0.05 level, we fail to reject the null hypothesis that the distribution of the average residuals across offices are spatially uncorrelated. (yay!)
```{r}
offices_grouped <- cnty_clus_offices |>
  group_by(office) |>
  mutate(avg_aor_crim_resid = mean(aor_crim_resids)) |>
  slice(1) |>
  ungroup()

office_coords <- st_coordinates(offices_grouped)

w1 <- 1/as.matrix(st_distance(offices_grouped ,
                              offices_grouped))
w1[is.infinite(w1)] <- 0

attr(w1, "class") <- NULL

moran.test(offices_grouped$avg_aor_crim_resid, mat2listw(w1, style="W"))
```

## Interaction Proportion Hispanic:cluster
```{r}
cluster_hisp <- glm(deported ~ criminality +cluster + avg_p_his:cluster+ gender + age + region + avg_p_blk + avg_p_asn  + avg_p_his +  avg_p_nc  + avg_pop_sqm, 
               family = binomial,
               data = cnty_clus_offices)

saveRDS(cluster_hisp, file="cluster_hisp.rds")
```


```{r}
summary(cluster_hisp)
```


```{r}
cluster_hisp <- readRDS("models/cluster_hisp.rds")
```



#### Get coefficients for the interaction term for prop hispanic
```{r}
#### Get coefficients for age effects at cluster level
coefs <- summary(cluster_hisp)$coefficients

# Extract main effect of age
cluster_fixed_hisp <- coefs["avg_p_his", "Estimate"]

# Extract interaction terms
cluster_int_hisp <- coefs[grep(":avg_p_his$", rownames(coefs)), , drop = FALSE]

# Set non-significant interactions to 0
cluster_int_hisp[cluster_int_hisp[, "Pr(>|z|)"] > 0.05, "Estimate"] <- 0


# Create interaction dataframe - strip cluster prefix and :age suffix
hisp_interaction_df <- data.frame(
  cluster = sub("cluster", "", sub(":avg_p_his$", "", rownames(cluster_int_hisp))),
  cluster_int_hisp = cluster_int_hisp[, "Estimate"]
)

# Get all unique clusters
all_clusters <- unique(cluster_office_df$cluster)

# Add fixed effect and handle missing interactions
hisp_interaction_df <- data.frame(cluster = all_clusters) |>
  left_join(hisp_interaction_df, by = "cluster") |>
  mutate(
    clstr_hisp_fixed = cluster_fixed_hisp,
    cluster_hisp_int = replace_na(cluster_int_hisp, 0)
  )

# Calculate marginal effect
hisp_interaction_df <- hisp_interaction_df |>
  mutate(cluster_hisp_marg = clstr_hisp_fixed + cluster_hisp_int)


# Join to main dataframe
cluster_office_df <- cluster_office_df |>
  left_join(hisp_interaction_df, by = "cluster")
```



## Interaction Proportion Asian:cluster
```{r}
cluster_asian <- glm(deported ~ criminality + cluster + avg_p_asn :cluster+ gender + age + region + avg_p_blk + avg_p_asn  + avg_p_his +  avg_p_nc  + avg_pop_sqm, 
               family = binomial,
               data = cnty_clus_offices)

saveRDS(cluster_asian, file="cluster_asian.rds")
```

```{r}
cluster_asian <- readRDS("models/cluster_asian.rds")
```

```{r}
summary(cluster_asian)
```


#### Get coefficients for the interaction term for prop asian
```{r}
#### Get coefficients for age effects at cluster level
coefs <- summary(cluster_asian)$coefficients

# Extract main effect of age
cluster_fixed_asi <- coefs["avg_p_asn", "Estimate"]

# Extract interaction terms
cluster_int_asi <- coefs[grep(": avg_p_asn $", rownames(coefs)), , drop = FALSE]

# Set non-significant interactions to 0
cluster_int_asi[cluster_int_asi[, "Pr(>|z|)"] > 0.05, "Estimate"] <- 0


# Create interaction dataframe - strip cluster prefix and :age suffix
asi_interaction_df <- data.frame(
  cluster = sub("cluster", "", sub(": avg_p_asn $", "", rownames(cluster_int_asi))),
  cluster_int_asi = cluster_int_asi[, "Estimate"]
)


# Add fixed effect and handle missing interactions
asi_interaction_df <- data.frame(cluster = all_clusters) |>
  left_join(asi_interaction_df, by = "cluster") |>
  mutate(
    clstr_asi_fixed = cluster_fixed_asi,
    cluster_asi_int = replace_na(cluster_int_asi, 0)
  )

# Calculate marginal effect
asi_interaction_df <- asi_interaction_df |>
  mutate(cluster_asi_marg = clstr_asi_fixed + cluster_asi_int)


# Join to main dataframe
cluster_office_df <- cluster_office_df |>
  left_join(asi_interaction_df, by = "cluster")
```


## Interaction LatinAmerica:cluster
Make Latin America variable
```{r}
latin_am_regions = c("Central America", "Caribbean", "Mexico", "South America")

cnty_clus_offices <- cnty_clus_offices |>
  mutate(latin_cit = case_when(region == "Mexico" ~ "Mexico",
                                  region == "South America" ~ "South America",
                                  region == "Central America" | region == "Caribbean" ~ "Central America/Caribbean",
                                  !(region %in% latin_am_regions) ~ "Non-Latin")) 

cnty_clus_offices$latin_cit <- factor(cnty_clus_offices$latin_cit)
cnty_clus_offices$latin_cit <- relevel(cnty_clus_offices$latin_cit, ref = "Non-Latin")

```

```{r}
freq_table <- table(cnty_clus_offices$latin_cit)
prop.table(freq_table)
```
```{r}
cluster_latin_cit<- glm(deported ~ criminality + cluster +latin_cit:cluster+ gender + age + latin_cit + avg_p_blk + avg_p_asn  + avg_p_his +  avg_p_nc  + avg_pop_sqm, 
               family = binomial,
               data = cnty_clus_offices)

saveRDS(cluster_latin_cit, file="cluster_latin_cit.rds")
```

```{r}
summary(cluster_latin_cit)
```

```{r}
cluster_latin_cit <- readRDS("models/cluster_latin_cit.rds")
```

#### Get coefficients for Latin citizenship effects at cluster level
```{r}

coefs <- summary(cluster_latin_cit)$coefficients

# Extract main effects for each Latin citizenship category
lat_fixed_mexico <- coefs["latin_citMexico", "Estimate"]
lat_fixed_samerica <- coefs["latin_citSouth America", "Estimate"]
lat_fixed_central <- coefs["latin_citCentral America/Caribbean", "Estimate"]

# Extract interaction terms for each category
cluster_int_mexico <- coefs[grep("latin_citMexico$", rownames(coefs)), , drop = FALSE]
cluster_int_samerica <- coefs[grep("latin_citSouth America$", rownames(coefs)), , drop = FALSE]
cluster_int_central <- coefs[grep("latin_citCentral America/Carribbean$", rownames(coefs)), , drop = FALSE]

# Set non-significant interactions to 0 for each category
cluster_int_mexico[cluster_int_mexico[, "Pr(>|z|)"] > 0.05, "Estimate"] <- 0
cluster_int_samerica[cluster_int_samerica[, "Pr(>|z|)"] > 0.05, "Estimate"] <- 0
cluster_int_central[cluster_int_central[, "Pr(>|z|)"] > 0.05, "Estimate"] <- 0

# Create interaction dataframes for each category
lat_mexico_df <- data.frame(
  cluster = sub("cluster", "", sub(":latin_citMexico$", "", rownames(cluster_int_mexico))),
  cluster_int_mexico = cluster_int_mexico[, "Estimate"]
)

lat_samerica_df <- data.frame(
  cluster = sub("cluster", "", sub(":latin_citSouth America$", "", rownames(cluster_int_samerica))),
  cluster_int_samerica = cluster_int_samerica[, "Estimate"]
)

lat_central_df <- data.frame(
  cluster = sub("cluster", "", sub(":latin_citCentral America/Carribbean$", "", rownames(cluster_int_central))),
  cluster_int_central = cluster_int_central[, "Estimate"]
)

# Get all unique clusters
all_clusters <- unique(cluster_office_df$cluster)

# Combine all Latin citizenship effects
lat_interaction_df <- data.frame(cluster = all_clusters) |>
  left_join(lat_mexico_df, by = "cluster") |>
  left_join(lat_samerica_df, by = "cluster") |>
  left_join(lat_central_df, by = "cluster") |>
  mutate(
    # Fixed effects (same for all clusters)
    lat_fixed_mexico = lat_fixed_mexico,
    lat_fixed_samerica = lat_fixed_samerica,
    lat_fixed_central = lat_fixed_central,
    
    # Interaction effects (vary by cluster, 0 if missing/non-sig)
    cluster_int_mexico = replace_na(cluster_int_mexico, 0),
    cluster_int_samerica = replace_na(cluster_int_samerica, 0),
    cluster_int_central = replace_na(cluster_int_central, 0)
  )

# Calculate marginal effects for each category
lat_interaction_df <- lat_interaction_df |>
  mutate(
    cluster_mexico_marg = lat_fixed_mexico + cluster_int_mexico,
    cluster_samerica_marg = lat_fixed_samerica + cluster_int_samerica,
    cluster_central_marg = lat_fixed_central + cluster_int_central
  )

# Join to main dataframe
cluster_office_df <- cluster_office_df |>
  left_join(lat_interaction_df, by = "cluster")
```







### Transform interaction terms into percent change
```{r}
head(cluster_office_df)
```



```{r}
cluster_office_df_transf <- cluster_office_df |>
  mutate(cluster_hisp_marg_10pt = cluster_hisp_marg * 0.10,
         cluster_asi_marg_10pt = cluster_asi_marg * 0.10) |> # for 10% increase interpretation
  mutate(across(
    .cols = c(crim_marg, aor_crim_marg, cluster_hisp_marg_10pt, cluster_asi_marg_10pt, cluster_mexico_marg, cluster_samerica_marg, cluster_central_marg),
    .fns = ~ (exp(.) - 1) * 100,
    .names = "{.col}_pctdiff"
  )) 

```

## Export coefficients

```{r}
saveRDS(cluster_office_df_transf, file = "mapping_coefs.rds") 
```

```{r}
st_write(cluster_office_df_transf, "data/mapping_coefs.gpkg")
```


### AIC model comparision
The model interacting cluster with criminality status has the lowest AIC
```{r}
print(AIC(cluster_reg_crim))
print(AIC(cluster_age))
print(AIC(cluster_hisp))
print(AIC(cluster_asian))
print(AIC(cluster_lat_am))
```

# GWR with aggregated offices
My computer crashes every time I try to compute the distance matrix because there are so many observations. So, my plan is to aggregate the data by office, but assign weights to offices with more datapoints. 

```{r}
# aggregate by offices
office_agg <- cnty_clus_offices |>
  group_by(office) |>
  reframe(prop_central_am = mean(region == "Central America"),
         prop_south_am = mean(region == "South America"),
         prop_caribbean = mean(region == "Caribbean"),
         prop_mexico = mean(region == "Mexico"),
         prop_europe = mean(region == "Europe"),
         prop_asia = mean(region == "Asia"),
         prop_canada = mean(region == "Canada"),
         prop_africa = mean(region == "Africa"),
         prop_oceania = mean(region == "Oceania"),
         prop_latin_america = mean(region == "Central America" | region == "South America" | region == "Caribbean" |region == "Mexico"),
         prop_crim_or_pending = mean(criminality == "1 Convicted Criminal" | criminality == "2 Pending Criminal Charges"),
         prop_female = mean(gender == "Female"),
         prop_male = mean(gender == "Male"),
         avg_prop_asn = mean(avg_p_asn),
         avg_prop_his = mean(avg_p_his),
         avg_prop_blk = mean(avg_p_blk),
         avg_prop_nc = mean(avg_p_nc),
         avg_pop_sqm = mean(avg_pop_sqm),
         avg_age = mean(age), 
         prop_deported = mean(deported == 1),
         num_encounters = num_encounters,
         office = office,
         aor = aor,
         geom = st_union(geom)) |>
   distinct(office, .keep_all = TRUE)

office_agg_sf <- st_as_sf(
  office_agg,
  sf_column_name = "geom",
  crs = st_crs(cnty_clus_offices)  
)
```


```{r}
head(office_agg)
sd(office_agg$prop_latin_america)
sd(office_agg$prop_central_am)
sd(office_agg$prop_south_am)
sd(office_agg$prop_mexico)
sd(office_agg$prop_africa)
sd(office_agg$prop_asia)
```

Note: summary statistics won't really make sense here because of the unequal distribution of encounters per office (weighting would need to be done first)

```{r}
office_agg |>
  summarize(min(num_encounters),
            max(num_encounters),
            mean(num_encounters),
            median(num_encounters),
            sd(num_encounters))
```


```{r}
office_agg_sp <- as(office_agg_sf, "Spatial")

bw <- bw.gwr(prop_deported ~ prop_central_am + prop_south_am + prop_mexico + prop_crim_or_pending + prop_female + avg_prop_asn + avg_prop_his + avg_prop_nc +avg_pop_sqm,
             data = office_agg_sp,
             approach = "CV",
             kernel = "bisquare",
             adaptive=TRUE)
```
## Fit OLS
```{r}
# ols first
ols_fit <- lm(prop_deported ~ prop_central_am + prop_south_am + prop_mexico + prop_crim_or_pending + prop_female + avg_prop_asn + avg_prop_his  + avg_prop_nc + num_encounters,
             data = office_agg_sp)

summary(ols_fit)
```

### Moran's I
```{r}
office_agg_sp$lm_resids <- ols_fit$residuals
```

At the alpha = 0.05 level, we fail reject the null hypothesis that the distribution of the average residuals across offices are spatially uncorrelated. We conclude that there is not sufficient evidence of clustering behavior of the residuals. However, since the p-value is still < 0.1, I think it's worth it to try running GWR.
```{r}
office_agg_sf <- st_as_sf(office_agg_sp)
office_coords <- st_coordinates(office_agg_sf)


w1 <- 1/as.matrix(st_distance(office_agg_sf,
                              office_agg_sf))
w1[is.infinite(w1)] <- 0

attr(w1, "class") <- NULL

moran.test(office_agg_sp$lm_resids, mat2listw(w1, style="W"))
```


```{r}
# replaced population density with number of encounters
gwr_fit <- gwr.basic(prop_deported ~ prop_central_am + prop_south_am + prop_mexico + prop_crim_or_pending + prop_female + avg_prop_asn + avg_prop_his  + avg_prop_nc + num_encounters,
             data = office_agg_sp,
             bw = bw,
             kernel = "bisquare",
             adaptive=TRUE)

gwr_results <- st_as_sf(gwr_fit$SDF)
gwr_fit 
```



```{r}
# alpha* adjustment

#effective number of parameters
pe <- 20.84718 
n <- nrow(office_agg_sp)
p <- 9

alpha_star <- 0.05/(1+pe - pe/(n*p))
alpha_star
df <- n - p - 1
t_star <- qt(1-alpha_star, df = df)
t_star 
```


```{r}
# assign significance
gwr_results <- gwr_results |>
  mutate(sig_crim = ifelse(abs(prop_crim_or_pending_TV) > t_star, prop_crim_or_pending, 0),
         sig_central_am = ifelse(abs(prop_central_am_TV) > t_star, prop_central_am, 0),
         sig_south_am = ifelse(abs(prop_south_am_TV) > t_star, prop_south_am, 0),
         sig_mexico = ifelse(abs(prop_mexico_TV) > t_star, prop_mexico, 0),
         sig_his = ifelse(abs(avg_prop_his_TV) > t_star,avg_prop_his, 0),
         sig_asn = ifelse(abs(avg_prop_asn_TV) > t_star, avg_prop_asn, 0),
         sig_female = ifelse(abs(prop_female_TV)> t_star, prop_female, 0))

hist(gwr_results$sig_crim)
hist(gwr_results$sig_central_am)
hist(gwr_results$sig_south_am)
hist(gwr_results$sig_mexico)
hist(gwr_results$sig_his)
hist(gwr_results$sig_asn)
hist(gwr_results$sig_female)

```

```{r}
# basic plot
gwr_results <- st_transform(gwr_results, st_crs(cnty_clus_offices))

# plot local coefficients as quintiles
# criminality
q_criminal <- quantile(gwr_results$sig_crim,
                       probs = seq(0, 1, 0.1),
                       na.rm=TRUE)

gwr_results$coef_crim_q <- case_when(
  gwr_results$sig_crim == 0 ~ "Zero",
  TRUE ~ as.character(cut(gwr_results$sig_crim,
                          breaks = unique(q_criminal),
                          include.lowest = TRUE))
)

plot_crim <- ggplot(gwr_results) +
  geom_sf(aes(color = coef_crim_q), linewidth = 0.2) +
  scale_color_manual(
    values = c("Zero" = "gray50", 
               setNames(viridis(5, direction = -1), 
                       levels(cut(gwr_results$sig_crim, 
                                 breaks = unique(q_criminal), 
                                 include.lowest = TRUE)))),
    name = "Coefficient"
  ) +
  theme_bw(base_size = 12) + 
  ggtitle("Criminal/Pending Criminal Charges Coef. (quintiles)")

plot_crim

```


```{r}
# 100% significant: space maters
# being from central america
# criminality
q_central_am <- quantile(gwr_results$sig_central_am,
                       probs = seq(0, 1, 0.2),
                       na.rm=TRUE)

gwr_results$coef_central_am_q <- case_when(
  gwr_results$sig_central_am == 0 ~ "Zero",
  TRUE ~ as.character(cut(gwr_results$sig_central_am,
                          breaks = unique(q_central_am),
                          include.lowest = TRUE))
)

plot_central_am <- ggplot(gwr_results) +
  geom_sf(aes(color = coef_central_am_q), linewidth = 0.2) +
  scale_color_manual(
    values = c("Zero" = "gray50", 
               setNames(viridis(5, direction = -1), 
                       levels(cut(gwr_results$sig_central_am, 
                                 breaks = unique(q_central_am), 
                                 include.lowest = TRUE)))),
    name = "Coefficient"
  ) +
  theme_bw(base_size = 12) + 
  ggtitle("Citizenship from Central America Coef. (quintiles)")

plot_central_am

```

```{r}
# 0% significant: no spatial variation?
q_south_am <- quantile(gwr_results$prop_south_am,
                       probs = seq(0, 1, 0.2),
                       na.rm=TRUE)

gwr_results$coef_south_am_q <- case_when(
  gwr_results$sig_south_am == 0 ~ "Zero",
  TRUE ~ as.character(cut(gwr_results$sig_south_am,
                          breaks = unique(q_south_am),
                          include.lowest = TRUE))
)

plot_south_am <- ggplot(gwr_results) +
  geom_sf(aes(color = coef_south_am_q), linewidth = 0.2) +
  scale_color_manual(
    values = c("Zero" = "gray50", 
               setNames(viridis(5, direction = -1), 
                       levels(cut(gwr_results$sig_south_am, 
                                 breaks = unique(q_south_am), 
                                 include.lowest = TRUE)))),
    name = "Coefficient"
  ) +
  theme_bw(base_size= 12) + 
  theme_bw() 
  ggtitle("Citizenship in South America Coef. (quintiles)")

plot_south_am
```

```{r}
q_mexico <- quantile(gwr_results$prop_mexico,
                       probs = seq(0, 1, 0.2),
                       na.rm=TRUE)

gwr_results$coef_mexico_q <- case_when(
  gwr_results$sig_mexico == 0 ~ "Zero",
  TRUE ~ as.character(cut(gwr_results$sig_mexico,
                          breaks = unique(q_mexico),
                          include.lowest = TRUE))
)


plot_mexico <- ggplot(gwr_results) +
  geom_sf(aes(color = coef_mexico_q), linewidth = 0.2) +
  scale_color_manual(
    values = c("Zero" = "gray50", 
               setNames(viridis(5, direction = -1), 
                       levels(cut(gwr_results$sig_mexico, 
                                 breaks = unique(q_mexico), 
                                 include.lowest = TRUE)))),
    name = "Coefficient"
  ) +
  theme_bw(base_size= 12) + 
  theme_bw() 
  ggtitle("Citizenship in Mexico Coef. (quintiles)")

plot_mexico
```

```{r}
q_his <- quantile(gwr_results$sig_his,
                       probs = seq(0, 1, 0.2),
                       na.rm=TRUE)

gwr_results$coef_his_q <- case_when(
  gwr_results$sig_his == 0 ~ "Zero",
  TRUE ~ as.character(cut(gwr_results$sig_his,
                          breaks = unique(q_his),
                          include.lowest = TRUE))
)

plot_his<- ggplot(gwr_results) +
  geom_sf(aes(color = coef_his_q), linewidth = 0.2) +
 scale_color_manual(
    values = c("Zero" = "gray50", 
               setNames(viridis(5, direction = -1), 
                       levels(cut(gwr_results$sig_his, 
                                 breaks = unique(q_his), 
                                 include.lowest = TRUE)))),
    name = "Coefficient"
  ) +
  theme_bw(base_size= 12) + 
  theme_bw() 
  ggtitle("Local Hispanic/Latinx Proportion Coef. (quintiles)")

plot_his
```

```{r}
q_asn <- quantile(gwr_results$avg_prop_asn,
                       probs = seq(0, 1, 0.2),
                       na.rm=TRUE)

gwr_results$coef_asn_q <- case_when(
  gwr_results$sig_asn == 0 ~ "Zero",
  TRUE ~ as.character(cut(gwr_results$sig_asn,
                          breaks = unique(q_asn),
                          include.lowest = TRUE))
)

plot_asn<- ggplot(gwr_results) +
  geom_sf(aes(color = coef_asn_q), linewidth = 0.2) +
 scale_color_manual(
    values = c("Zero" = "gray50", 
               setNames(viridis(5, direction = -1), 
                       levels(cut(gwr_results$sig_asn, 
                                 breaks = unique(q_asn), 
                                 include.lowest = TRUE)))),
    name = "Coefficient"
  ) +
  theme_bw(base_size= 12) + 
  theme_bw() 
  ggtitle("Local Asian Proportion Coef. (quintiles)")

plot_asn
```

```{r}
q_female <- quantile(gwr_results$sig_female,
                       probs = seq(0, 1, 0.2),
                       na.rm=TRUE)

gwr_results$coef_female_q <- case_when(
  gwr_results$sig_female == 0 ~ "Zero",
  TRUE ~ as.character(cut(gwr_results$sig_female,
                          breaks = unique(q_female),
                          include.lowest = TRUE))
)

plot_prop_female<- ggplot(gwr_results) +
  geom_sf(aes(color = coef_female_q), linewidth = 0.2) +
  scale_color_manual(
    values = c("Zero" = "gray50", 
               setNames(viridis(5, direction = -1), 
                       levels(cut(gwr_results$sig_female, 
                                 breaks = unique(q_female), 
                                 include.lowest = TRUE)))),
    name = "Coefficient"
  ) +
  theme_bw(base_size= 12) + 
  theme_bw() 
  ggtitle("Proportion Female Coef. (quintiles)")

plot_prop_female
```

Only plot significant coefficients
```{r}
gwr_results <- gwr_results |>
  mutate(sig_)
```



# Stuff not included in paper
## Get predicted probabilities of deportation from cluster:criminality regression model
```{r}
pred_odds <- exp(predict(cluster_reg_crim))
pred_probs <- pred_odds / (pred_odds + 1)

cnty_clus_offices$pred_prob <- pred_probs
```

```{r}
cnty_clus_offices |>
  select(deported, pred_prob) |> 
  st_drop_geometry() |>
  slice_sample(n=10)
```


### Do train/test split to get confusion matrix, F1 score, and ROC curve
```{r}
set.seed(888)


cnty_clus_offices_older <- cnty_clus_offices |>
  filter(evnt_dt < as.Date("2025-04-27"))

# create train-test split, createDataPartition already shuffles your data
split_idx <- createDataPartition(cnty_clus_offices_older$deported, p = 0.8, list=FALSE)

encounters_train = cnty_clus_offices[split_idx, ]

encounters_test = cnty_clus_offices[-split_idx, ]



```

```{r}
cluster_reg_train <- glm(deported ~ criminality +criminality:cluster+ gender + age + region + fnl_prg + avg_p_blk + avg_p_asn  + avg_p_his + avg_pop_sqm, 
               family = binomial,
               data = encounters_train)
```


```{r}
saveRDS(cluster_reg_train, file="cluster_reg_train.rds")
```

```{r}
cluster_reg_train<- readRDS("cluster_reg_train.rds")
```


Get predictions from test set
```{r}
pred_probs <- predict(cluster_reg_train, newdata = encounters_test, type = "response")
```

ROC curve to decide where to place the "threshold" for classification
```{r}
roc_curve <- roc(response = encounters_test$deported, predictor = pred_probs)

plot(roc_curve, main = "ROC Curve", print.auc=TRUE,
     xlim = c(0, 1))
auc(roc_curve)
```


```{r}
# convert probabilities to predicted class
# TODO: ask about this
pred_dep <- ifelse(pred_probs >= 0.50, "1", "0")
pred_dep <- factor(pred_dep, levels= levels(encounters_test$deported))

# create confusion matrix
confusionMatrix(
  data = pred_dep,
  reference = encounters_test$deported,
  positive = "1" # well, not actually "positive"
)

```
```{r}
# proportion of deport predictions that were actually correct 
precision <- posPredValue(pred_dep, encounters_test$deported, positive = "1")

# proportion of correctly predicted deported cases
recall <- sensitivity(pred_dep, encounters_test$deported, positive = "1")

f1 <- (2*precision * recall) / (precision + recall)

print(precision)
print(recall)
print(f1)
```


```{r}
hist(pred_probs)
```

