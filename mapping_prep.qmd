---
title: "mapping prep"
format: html
editor: source
---
```{r}
library(tidyverse)
library(sf)
library(spdep)
select <- dplyr::select
```

```{r}
coefs <- st_read("data/mapping_coefs_admin.gpkg")
#effect_sizes <- read_csv("data/effect_size_clusters.csv")
cnty_clus_offices <- readRDS("data/cnty_clus_offices.rds") 
```


```{r}
length(unique(coefs$cluster))
length(unique(cnty_clus_offices$cluster))
setdiff(unique(coefs$cluster), unique(cnty_clus_offices$cluster))
```


```{r}
num_enc_agged <- cnty_clus_offices |>
  group_by(cluster) |>
  summarize(num_enc_clus = n()) |>
  st_drop_geometry()

```



## Join datasets together
```{r}
coefs$cluster = as.character(coefs$cluster)
coefs_with_counts <- coefs |>
  left_join(num_enc_agged, by = "cluster")
 

head(coefs_with_counts)
```

```{r}
# get number of encounters by office - needed to calculate the weighted centroid
enc_by_office <- cnty_clus_offices |>
  group_by(office) |>
  slice(1) |>
  select(office, num_encounters, cluster) |>
  rename("num_enc_office" = "num_encounters") |>
  st_drop_geometry()

coefs_with_counts <- coefs_with_counts |>
  left_join(enc_by_office,
            by =  c("office", "cluster")) 


```

```{r}
class(coefs_with_counts)
```



## Find centroids for each cluster, weighted by number of encounters per office
```{r}
cluster_centroids <- coefs_with_counts |>
  # exclude hawaii and alaska for mapping
  filter(office != "HONOLULU, HI, DOCKET CONTROL OFFICE", 
         office != "ANCHORAGE, AK, DOCKET CONTROL OFFICE") |> 
  mutate(coords = st_coordinates(geom)) |>
  group_by(cluster) |>
  mutate(
    weighted_centroid = st_sfc(
      st_point(c(
        weighted.mean(coords[, "X"], w = num_enc_office),
        weighted.mean(coords[, "Y"], w = num_enc_office)
      )),
      crs = st_crs(geom)  
    )
  ) |>
  ungroup() |>
  st_drop_geometry() |> 
  select(-c(coords)) |>
  st_as_sf(sf_column_name = "weighted_centroid") |>   
  st_transform("ESRI:102010")  

```

```{r}
plot(cluster_centroids$weighted_centroid)
```

```{r}
length(unique(cluster_centroids$cluster))
```

```{r}
min(cluster_centroids$num_enc_clus)
max(cluster_centroids$num_enc_clus)
```

## Export for mapping
```{r}
saveRDS(cluster_centroids, "data/cluster_centroids.rds")
#cluster_centroids <- readRDS("data/cluster_centroids.rds")
gc()
st_write(cluster_centroids, "data/cluster_centroids.gpkg")
```

```{r}
#cluster_centroids<- st_read("data/cluster_centroids.gpkg")
```


```{r}
length(unique(cnty_clus_offices$office))
nrow(cluster_centroids)
```


For size of dots
```{r}

quantile(cluster_centroids$num_enc_clus)
```



