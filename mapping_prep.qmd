---
title: "mapping prep"
format: html
editor: source
---
```{r}
library(tidyverse)
library(sf)
library(spdep)
```

```{r}
coefs <- st_read("data/mapping_coefs.gpkg")
#effect_sizes <- read_csv("data/effect_size_clusters.csv")
cnty_clus_offices <- st_read("data/cnty_clus_offices.gpkg") 
```

```{r}
head(coefs)
```

```{r}
num_enc_agged <- cnty_clus_offices |>
  group_by(cluster) |>
  summarize(num_enc_clus = n()) |>
  st_drop_geometry()

```



## Join datasets together
```{r}
coefs_with_counts <- coefs |>
  left_join(num_enc_agged, by = "cluster") 
 

#head(coefs_with_counts)
```

```{r}
# get number of encounters by office - needed to calculate the weighted centroid
enc_by_office <- cnty_clus_offices |>
  group_by(office) |>
  slice(1) |>
  select(office, num_encounters, cluster) 

coefs_with_counts <- coefs_with_counts |>
  left_join(st_drop_geometry(enc_by_office),
            by = c("office", "cluster"))

coefs_with_counts <- coefs_with_counts|>
  rename("num_enc" = "num_encounters")
```


## Find centroids for each cluster, weighted by number of encounters
```{r}
cluster_centroids <- coefs_with_counts |>
  # exclude hawaii and alaska for mapping
  filter(office != "HONOLULU, HI, DOCKET CONTROL OFFICE", 
         office != "ANCHORAGE, AK, DOCKET CONTROL OFFICE") |> 
  mutate(coords = st_coordinates(geom)) |>
  group_by(cluster) |>
  mutate(
    weighted_centroid = st_sfc(
      st_point(c(
        weighted.mean(coords[, "X"], w = num_enc),
        weighted.mean(coords[, "Y"], w = num_enc)
      )),
      crs = st_crs(geom)  
    )
  ) |>
  ungroup() |>
  st_drop_geometry() |> 
  select(-c(coords, office)) |>
  st_as_sf(sf_column_name = "weighted_centroid") |>   
  st_transform("ESRI:102010")  

```

```{r}
plot(cluster_centroids$weighted_centroid)
```

```{r}
head(cluster_centroids)
```

```{r}
min(cluster_centroids$num_enc_clus)
max(cluster_centroids$num_enc_clus)
```

## Export for mapping
```{r}
st_write(cluster_centroids, "data/cluster_centroids.gpkg")
```

```{r}
cluster_centroids<- st_read("data/cluster_centroids.gpkg")
```
```{r}
cluster_centroids |>
  st_drop_geometry() |>
  drop_na() |>
  select(c(cluster, cluster_lat_effect_pctdiff)) |>
  mutate(min = min(cluster_lat_effect_pctdiff))
```


## Join AOR interaction terms with AOR polygons
```{r}
head(cluster_centroids)
```
```{r}
aor_info <- cluster_centroids |>
  select(aor, aor_crim_effect_pctdiff) |>
  group_by(aor) |>
  distinct() |>
  st_drop_geometry()
```

Read in AOR level shapefile
```{r}
aor_shapes <- st_read("data/aor_only_shapes/aor_shapes.shp")
```
```{r}

aor_shapes_pr <- st_transform(aor_shapes, crs=st_crs(cluster_centroids))
aor_shapes_pr <- aor_shapes_pr |>
  mutate(aor = ifelse(aor == "St Paul Area of Responsibility", "St. Paul Area of Responsibility", aor),
         aor = ifelse(aor == "DC Area of Responsibility", "Washington Area of Responsibility", aor))
  
```



```{r}
aor_joined <- aor_shapes_pr |>
  left_join(aor_info, by = "aor")
```


```{r}
aor_joined <- aor_joined |>
  group_by(aor) |>
  slice(1)

aor_joined
```


```{r}
st_write(aor_joined, "data/aor_coefs.gpkg")
```
```{r}
#aor_joined <- st_read("data/aor_coefs.gpkg")
```




Get reference AOR for mapping
```{r}
atl_aor <- aor_shapes_pr |>
  filter(aor == "Atlanta Area of Responsibility")

atl_aor
```
```{r}
st_write(atl_aor, "data/atl_aor.gpkg")
```

For size of dots
```{r}

quantile(cluster_centroids$num_enc_clus)
```

